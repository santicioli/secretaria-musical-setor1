data = [
    {church: '<a href="https://goo.gl/maps/G7Qn7CaX9ryRgVPN8">Agua Rasa</a>', 
        //gem:{day: '', hour:''},
        local:{description: '3º sáb. às 17:00h', day: 6, weekOfMoth: 3},
    },
    {church: '<a href="https://goo.gl/maps/oZWGJamfHD1yu36K6">Americanópolis</a>', 
        gem:{description: '4º sex. às 20:00h', day: 5, weekOfMoth: 4},
        local:{description: '2º sáb. às 17:00h', day: 6, weekOfMoth: 2},
    },
    {church: '<a href="https://goo.gl/maps/q38firHnsG44yPJS9">Baixada do Glicério</a>', 
        //gem:{day: '', hour:''},
        local:{description: '1º sáb. às 17:00h', day: 6, weekOfMoth: 1},
    },
    {church: '<a href="https://goo.gl/maps/h5k5VATu1q4Dbncz6">Barra Funda</a>', 
        gem:{description: 'último sáb. às 14:30h', day: 6, weekOfMoth: -1},
        local:{description: '1º dom. às 16:00h', day: 0, weekOfMoth: 1},
    },
	{church: '<a href="https://goo.gl/maps/gp4VdETQsbRZiH4x9">Belém</a>', 
        gem:{description: '2º sex. às 19:00h</b>', day: 5, weekOfMoth: 2},
        local:{description: '4º sáb. às 19:30h', day: 6, weekOfMoth: 4},
    },
	{church: '<a href="https://goo.gl/maps/DCdi4MBDcd7aV8TW8">Bom Retiro</a>',
        gem:{description: 'todo o dom. às 09:10h <b>(Fim do GEM)</b>', day: 0, weekOfMoth: 0},
        local:{description: '1º sáb. às 17:00h', day: 6, weekOfMoth: 1},
    },
    {church: '<a href="https://goo.gl/maps/YiyrRsnXudyENdie6">Bosque da Saúde</a>', 
        gem:{description: 'última qua. às 20:00h', day: 3, weekOfMoth: -1},
        local:{description: 'último dom. às 16:00h', day: 0, weekOfMoth: -1},
    },
    {church: '<a href="https://goo.gl/maps/u93cJ55CEZTMGcrLA">Brás</a>', 
        //gem:{day: '', hour:''},
        local:{description: '4º dom. às 16:00h', day: 0, weekOfMoth: 4},
    },
    {church: '<a href="https://goo.gl/maps/nxgr3wYUK98JD9aH7">Canindé</a>', 
        //gem:{day: '', hour:''},
        local:{description: '2º sáb. às 16h30h', day: 6, weekOfMoth: 2},
    },
    {church: '<a href="https://goo.gl/maps/nsYJQV9yiVCrbrHm8">Caraguatá</a>', 
        gem:{description: '1º ter. às 19:30h', day: 2, weekOfMoth: 1},
        local:{description: '1º dom. às 16:00h', day: 0, weekOfMoth: 1},
    },
    {church: '<a href="https://goo.gl/maps/PfxX3rWpAdvDpepP9">Flor da Vila Formosa</a>', 
        gem:{description: 'última qua. às 19:30h', day: 3, weekOfMoth: -1}, 
        local:{description: '3º sáb. às 16:30h', day: 6, weekOfMoth: 3},
    },
    {church: '<a href="https://goo.gl/maps/j5YGNgbdPyehFMUi6">Ipiranga</a>', 
        //gem:{day: '', hour:''},
        local:{description: '4º sáb. às 16:00h', day: 6, weekOfMoth: 4},
    },
    {church: '<a href="https://goo.gl/maps/x1dM8vfsD8CH9LRbA">Jabaquara</a>', 
        gem:{description: 'última qui. às 19:30h', day: 4, weekOfMoth: -1},
        local:{description: 'último dom. às 16:00h', day: 0, weekOfMoth: -1},
    },
    {church: '<a href="https://goo.gl/maps/x1dM8vfsD8CH9LRbA">Jardim da Glória</a>', 
        gem:{description: '2º sáb. às 17:00h', day: 6, weekOfMoth: 2},
        local:{description: '4º dom. às 16:00h', day: 0, weekOfMoth: 4},
    },
    {church: '<a href="https://goo.gl/maps/oBvAgiFfnpestN4c8">Jardim Elba</a>', 
        gem:{description: '2º sáb. às 15:00h', day: 6, weekOfMoth: 2},
        local:{description: '4º dom. às 16:00h', day: 0, weekOfMoth: 4},
    },
    {church: '<a href="https://goo.gl/maps/h6uKTbYrhtYYaYVHA">Jardim Independência</a>', 
        gem:{description: '4º sáb. às 15:00h', day: 6, weekOfMoth: 4},
        local:{description: '2º sáb. às 19:30h', day: 6, weekOfMoth: 2},
    },
    {church: '<a href="https://goo.gl/maps/LfUxnUYqHgKgxWBZ9">Jardim Maria Estela</a>', 
        gem:{description: '3º sáb. às 16:00h', day: 6, weekOfMoth: 3},
        local:{description: '4º dom. às 16:00h', day: 0, weekOfMoth: 4},
    },
    {church: '<a href="https://goo.gl/maps/csf7kQ4wHnYJczLAA">Jardim Mimar</a>', 
        gem:{description: '3ª ter. às 20:00h', day: 2, weekOfMoth: 3},
        local:{description: '3º sáb. às 19:30h', day: 6, weekOfMoth: 3},
    },
    {church: '<a href="https://goo.gl/maps/Cwfc231pLXe2SJHp8">Jardim Panorama</a>', 
        gem:{description: '3º sáb. às 14:30h', day: 6, weekOfMoth: 3},
        local:{description: 'último dom. às 16:00h', day: 0, weekOfMoth: -1},
    },
    {church: '<a href="https://goo.gl/maps/umzXqZ6dCfM4BEhj9">Jardim Planalto</a>', 
        gem:{description: 'última qui. às 19:30h', day: 4, weekOfMoth: -1},
        local:{description: '1º dom. às 16:00h', day: 0, weekOfMoth: 1},
    },
    {church: '<a href="https://goo.gl/maps/64iYaNrSfnaQ94uE7">Jardim Santo Eduardo</a>', 
        gem:{description: '2ª qua. às 19:00h', day: 3, weekOfMoth: 2},
        local:{description: '1º dom. às 16:00h', day: 0, weekOfMoth: 1},
    },
    {church: '<a href="https://goo.gl/maps/45xcGxTEdY7NPyabA">Jardim São Roberto</a>', 
        gem:{description: '1º sáb. às 10:30h <b>(Fim do GEM)</b>', day: 6, weekOfMoth: 1},
        local:{description: 'último dom. às 16:00h', day: 0, weekOfMoth: -1},
    },
    {church: '<a href="https://goo.gl/maps/rS7zFcXcya9jzF8u5">Jardim São Savério</a>', 
        //gem:{day: '', hour: ''},
        local:{description: 'último dom. às 16:00h', day: 0, weekOfMoth: -1},
    },
    {church: '<a href="https://goo.gl/maps/jKsr23T8JJPRZa7R6">Jardim Yara</a>', 
        //gem:{day: '', hour:''},
        local:{description: '3º sáb. às 19:30h', day: 6, weekOfMoth: 3},
    },
    {church: '<a href="https://goo.gl/maps/SQCfco2fdc1QDnTi6">Parque Santa Madalena</a>', 
        gem:{description: 'última qui. às 20:00h', day: 4, weekOfMoth: -1},
        local:{description: '4º sex. às 20:00h', day: 5, weekOfMoth: 4},
    },
    {church: '<a href="https://goo.gl/maps/SD2DpycwXu1JkHjx8">Parque São Lucas</a>', 
        gem:{description: 'última qua. às 19:30h', day: 3, weekOfMoth: -1},
        local:{description: '1º sáb. às 16:30h', day: 6, weekOfMoth: 1},
    },
    {church: 'Parque Sevilha', 
        //gem:{day: '', hour:''},
        local:{description: 'Não tem ensaio', day: 50, weekOfMoth: -2},
    },
    {church: '<a href="https://goo.gl/maps/PA9dgQGcpQz6LpBE6">Ponte Pequena</a>', 
        gem:{description: '1º sáb. às 15:00h', day: 6, weekOfMoth: 1},
        local:{description: '3º qua. às 19:30h', day: 3, weekOfMoth: 3},
    },
    {church: '<a href="https://goo.gl/maps/PA9dgQGcpQz6LpBE6">São João Clímaco</a>', 
        //gem:{day: '', hour:''},
        local:{description: '4º sáb. às 17:00h', day: 6, weekOfMoth: 4},
    },
    {church: '<a href="https://goo.gl/maps/snikN2xpT5XDMj1LA">Sapopemba</a>', 
        //gem:{day: '', hour:''},
        local:{description: '1º sex. às 19:30h', day: 5, weekOfMoth: 1},
    },
    {church: '<a href="https://goo.gl/maps/qH8TFubXB8QwQN57A">Sítio Pinheirinho</a>', 
        //gem:{day: '', hour:''},
        local:{description: '3º sáb. às 19:30h', day: 6, weekOfMoth: 3},
    },
    {church: '<a href="https://goo.gl/maps/9oS1haexWvDVWzW3A">Vila Alpina</a>', 
        gem:{description: '3ª sex. às 19:30h', day: 5, weekOfMoth: 3},
        local:{description: '4º dom. às 16:00h', day: 0, weekOfMoth: 4},
    },
    {church: '<a href="https://goo.gl/maps/27V1jJiFeu8gJTPB6">Vila Arapuá</a>', 
        //gem:{day: '', hour:''},
        local:{description: '1º dom. às 16:00h', day: 0, weekOfMoth: 1},
    },
    {church: '<a href="https://goo.gl/maps/SVZoZkWf3p7i5wif9">Vila Bela</a>', 
        gem:{description: 'toda a ter. às 21:30h <b>(Fim do GEM)</b>', day: 2, weekOfMoth: 0},
        local:{description: '1º sex. às 20:00h', day: 5, weekOfMoth: 1},
    },
    {church: '<a href="https://goo.gl/maps/SVZoZkWf3p7i5wif9">Vila California</a>', 
        gem:{description: 'última qua. às 20:00h', day: 3, weekOfMoth: -1},
        local:{description: '4º dom. às 16:00h', day: 0, weekOfMoth: 4},
    },
    {church: '<a href="https://goo.gl/maps/cKUZJHp1abKdBksx6">Vila Carioca</a>', 
        gem:{description: '2ª seg. às 19:30h', day: 1, weekOfMoth: 2},
        local:{description: '4º dom. às 16:00h', day: 0, weekOfMoth: 4},
    },
    {church: '<a href="https://goo.gl/maps/524qYBqrHHKXzVHGA">Vila Clara</a>', 
        gem:{description: '4º sáb. às 15:00h', day: 6, weekOfMoth: 4},
        local:{description: '3º sex. às 19:30h', day: 2, weekOfMoth: 3},
    },
    {church: '<a href="https://goo.gl/maps/utTnvA1AbMqRy87CA">Vila Diva</a>', 
        gem:{description: 'todo o sáb. às 16:00h <b>(Fim do GEM)</b>', day: 6, weekOfMoth: 0},
        local:{description: 'último sáb. às 16:30h', day: 6, weekOfMoth: -1},
    },
    {church: '<a href="https://goo.gl/maps/8iaoff3gQGLGvUSH8">Vila Ema</a>', 
        gem:{description: 'última ter. às 19:30h', day: 2, weekOfMoth: -1},
        local:{description: '2º sáb. às 19:30h', day: 6, weekOfMoth: 2},
    },
    {church: '<a href="https://goo.gl/maps/3uomPagvm6kXvm84A">Vila Formosa</a>', 
        gem:{description: 'último dom. às 09:00h', day: 0, weekOfMoth: -1},
        local:{description: '4º dom. às 16h30h', day: 0, weekOfMoth: 4},
    },
    {church: '<a href="https://goo.gl/maps/N3BFzosEHCgZuk1t6">Vila Guarani</a>', 
        gem:{description: 'toda a seg. às 20:00h <b>(Fim do GEM)</b>', day: 1, weekOfMoth: 0},
        local:{description: '2º sáb. às 17:00h', day: 6, weekOfMoth: 2},
    },
    {church: '<a href="https://goo.gl/maps/XiQgY2V7DPtrQeVK8">Vila Independência</a>', 
        gem:{description: '1º sáb. às 14:00h', day: 6, weekOfMoth: 1},
        local:{description: '4º dom. às 16:00h', day: 0, weekOfMoth: 4},
    },
    {church: '<a href="https://goo.gl/maps/gGU86mzDkABGvJLV6">Vila Livieiro</a>', 
        gem:{description: '3ª seg. às 19:30h', day: 1, weekOfMoth: 3},
        local:{description: 'último dom. às 16:00h', day: 0, weekOfMoth: -1},
    },
    {church: '<a href="https://goo.gl/maps/7G3yLP3jbkZUayz89">Vila Mariana</a>', 
        //gem:{day: '', hour:''},
        local:{description: 'último dom. às 16:00h', day: 0, weekOfMoth: -1},
    },
    {church: '<a href="https://goo.gl/maps/LvpTgn7gaPMuFzcm9">Vila Moraes</a>', 
        //gem:{day: '', hour:''},
        local:{description: '1º dom. às 16:00h', day: 0, weekOfMoth: 1},
    },
    {church: '<a href="https://goo.gl/maps/JnjjXa4nJMhesvJd8">Vila Prudente</a>', 
        gem:{description: 'última seg. às 19:30h', day: 1, weekOfMoth: -1},
        local:{description: '2º sex. às 19:30h', day: 5, weekOfMoth: 2},
    },
    {church: '<a href="https://goo.gl/maps/D8KR16teYmprGFBn6">Vila Rio Branco</a>', 
        gem:{description: '2ª e 4ª seg. às 20:30h <b>(Fim do GEM)</b>', day: 1, weekOfMoth: 2},
        local:{description: '1º sab. às 19:30h', day: 6, weekOfMoth: 1},
    },
]

function converterDataParaString(dataparaconversão) {
   
    // Extrai o dia, mês e ano da data calculada
    var dia = dataparaconversão.getDate();
    var mes = dataparaconversão.getMonth() + 1;
    var ano = dataparaconversão.getFullYear();
    
    // Formata os valores para dois dígitos
    dia = dia < 10 ? '0' + dia : dia;
    mes = mes < 10 ? '0' + mes : mes;
    
    // Cria a string da data no formato "DD/MM/AAAA"
    var dataString = dia + '/' + mes + '/' + ano;
    
    // Retorna a data formatada
    return dataString;
}

function verificarSeJaPassou(data) {
    let dataAtual = new Date();

    if (data < dataAtual) {
        return true; // A data já passou
    } else {
        return false; // A data ainda está por vir
    }
}

function calcMonthly(day, ordenação){
    let dataAtual = new Date();
    let mesAtual = dataAtual.getMonth();
    let contadorDeSemanas = 0;
    let resposta = 0;
    dataAtual.setDate(1);
    while (dataAtual.getMonth() === mesAtual) {
        if (dataAtual.getDay() === day) {
            contadorDeSemanas++;
            if (contadorDeSemanas === ordenação) {
                resposta = new Date(dataAtual);
            }
        }
        dataAtual.setDate(dataAtual.getDate() + 1);
    }
    if (verificarSeJaPassou(resposta)) {
        let dataAtual = new Date();
        let mesAtual = dataAtual.getMonth();
        let anoAtual = dataAtual.getFullYear();
        let contadorDeSemanas = 0;
        dataAtual.setDate(1);
        mesAtual++
        dataAtual.setFullYear(anoAtual, mesAtual, 1);
    
        while (dataAtual.getMonth() === mesAtual) {
            if (dataAtual.getDay() === day) {
                contadorDeSemanas++;
                if (contadorDeSemanas === ordenação) {
                  resposta = new Date(dataAtual);
                  return (converterDataParaString(resposta)); 
                }
              }
              dataAtual.setDate(dataAtual.getDate() + 1);
            }
        return null;
        }
    else {
        return (converterDataParaString(resposta));
    }
}

function calcWeekly(day) {
    var dataAtual = new Date();
    var diaSemanaAtual = dataAtual.getDay();
  
    var diasParaAdicionar = (day - diaSemanaAtual + 7) % 7; // Calcula a diferença em dias até o próximo dia da semana
  
    var proximaData = new Date(dataAtual.getFullYear(), dataAtual.getMonth(), dataAtual.getDate() + diasParaAdicionar);
  
    return converterDataParaString(proximaData);
}

function calcNextLastDayOfWeek(day) {
    var dataAtual = new Date();
    var ultimoDiaMes = new Date(dataAtual.getFullYear(), dataAtual.getMonth() + 1, 0);
  
    // Ajusta o objeto Date para o último dia da semana correspondente
    ultimoDiaMes.setDate(ultimoDiaMes.getDate() - (ultimoDiaMes.getDay() + (7 - day)) % 7);
    
    if (verificarSeJaPassou(ultimoDiaMes)) {
        var dataAtual = new Date();
        var ultimoDiaMes = new Date(dataAtual.getFullYear(), dataAtual.getMonth() + 2, 0);
        ultimoDiaMes.setDate(ultimoDiaMes.getDate() - (ultimoDiaMes.getDay() + (7 - day)) % 7);
        return converterDataParaString(ultimoDiaMes);
    }
    else{
        return converterDataParaString(ultimoDiaMes);
    }
}

function nextEvent(day, ordenação){
    /*Onde o 'day' representa um dia da semana de 0 (dom) a 6 (sáb), que vai de domingo a sabado.
    E o 'weekOfMoth' é um valor utilizado como ordenação das datas dentro do mês.
    Caso não tenha nenhuma consulta é atribuido o valor -2.
    Caso tenha consulta no último dia do mês, é atribuido o valor -1.
    Caso tenha consultas todos os dias é atribuido o valor 0.
    E os valores de 1 a 4 são 1° semana, ..., 4° semana, respectivamente.

    Para a buscar a response final é chamada uma função nextEvent();
    que verifica o valor da semana, e dependendo do valor chama uma função diferente,
    ou retorna null se o valor é -2.*/
    
    let response

    if (ordenação === -1){
        response = calcNextLastDayOfWeek(day)
        return response;
    }
    else if(ordenação === 0) {
        response = calcWeekly(day)
        return response;
    }
    else if(ordenação === -2) {
        return null;
    }
    else {
        response = calcMonthly(day, ordenação)
        return response;
    }
}

data.forEach(element => {

    if(element.hasOwnProperty('local')){

        var respostaFinal = nextEvent(element.local.day, element.local.weekOfMoth);
        let church = 
        `<tr>
            <td>
                ${element.church}
            </td>
            <td>
                ${element.local?.description}
            </td>
            <td>
                ${respostaFinal}
            </td>
        </tr>`

        $("#tb_local").append(church)
    }

    if(element.hasOwnProperty('gem')){

        var respostaFinal = nextEvent(element.gem.day, element.gem.weekOfMoth);
        let church = 
        `<tr>
            <td>
                ${element.church}
            </td>
            <td>
                ${element.gem?.description}
            </td>
            <td>
                ${respostaFinal}
            </td>
        </tr>`

        $("#tb_gem").append(church)
    }
});

$(document).ready(function() {
    
    $.fn.dataTable.moment( 'DD/MM/YYYY' );

    $('table.event').DataTable( {
        rowReorder: {
            selector: 'td:nth-child(2)'
        },
        responsive: true,
        paging: false,
        language: {
            search: "Pesquisar:",
            lengthMenu: "Show _MENU_ entries",
            info: "Mostrando _TOTAL_ igreja(s)",
            infoEmpty: "Mostrando 0 igreja",
            infoFiltered: "(Filtradas de _MAX_)",
            zeroRecords: "Nenhuma igreja encontrada",
        },
    } );
} );